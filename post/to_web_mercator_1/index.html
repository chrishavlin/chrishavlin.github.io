<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.81.0"><title>So you want to plot a global geoTIFF in web mercator... &#183; Chris Havlin</title><meta name=description content><meta itemprop=name content="So you want to plot a global geoTIFF in web mercator..."><meta itemprop=description content="Need to go from epsg:4326 to web mercator and you&rsquo;re a bit of a GIS n00b like me?"><meta itemprop=datePublished content="2022-11-10T17:13:08-06:00"><meta itemprop=dateModified content="2022-11-10T17:13:08-06:00"><meta itemprop=wordCount content="1403"><meta itemprop=image content="https://chrishavlin.github.io/images/turt.png"><meta itemprop=keywords content="code,geodata,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chrishavlin.github.io/images/turt.png"><meta name=twitter:title content="So you want to plot a global geoTIFF in web mercator..."><meta name=twitter:description content="Need to go from epsg:4326 to web mercator and you&rsquo;re a bit of a GIS n00b like me?"><meta property="og:title" content="So you want to plot a global geoTIFF in web mercator..."><meta property="og:description" content="Need to go from epsg:4326 to web mercator and you&rsquo;re a bit of a GIS n00b like me?"><meta property="og:type" content="article"><meta property="og:url" content="https://chrishavlin.github.io/post/to_web_mercator_1/"><meta property="og:image" content="https://chrishavlin.github.io/images/turt.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-11-10T17:13:08-06:00"><meta property="article:modified_time" content="2022-11-10T17:13:08-06:00"><meta property="og:site_name" content="Chris Havlin"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://chrishavlin.github.io/#author","name":null,"image":{"@type":"ImageObject","url":"https://chrishavlin.github.io/images/turt.png"},"description":" "},{"@type":"WebSite","@id":"https://chrishavlin.github.io/#website","url":"https://chrishavlin.github.io/","name":"Chris Havlin","description":" ","publisher":{"@id":"https://chrishavlin.github.io/#author"},"inLanguage":"en"},{"@type":"ImageObject","url":"https://chrishavlin.github.io/images/turt.png","caption":"Chris Havlin"},{"@type":"WebPage","@id":"https://chrishavlin.github.io/post/to_web_mercator_1/#webpage","url":"https://chrishavlin.github.io/post/to_web_mercator_1/","name":"So you want to plot a global geoTIFF in web mercator...","isPartOf":{"@id":"https://chrishavlin.github.io/#website"},"about":{"@id":"https://chrishavlin.github.io/#author"},"datePublished":"2022-11-10T17:13:08-06:00","dateModified":"2022-11-10T17:13:08-06:00","description":"Need to go from epsg:4326 to web mercator and you\u0026rsquo;re a bit of a GIS n00b like me?","inLanguage":"en","potentialAction":[{"@type":"ReadAction","target":["https://chrishavlin.github.io/post/to_web_mercator_1/"]}]},{"@type":"Article","isPartOf":{"@id":"https://chrishavlin.github.io/post/to_web_mercator_1/#webpage"},"mainEntityOfPage":{"@id":"https://chrishavlin.github.io/post/to_web_mercator_1/#webpage"},"headline":"So you want to plot a global geoTIFF in web mercator...","datePublished":"2022-11-10T17:13:08-06:00","dateModified":"2022-11-10T17:13:08-06:00","publisher":{"@id":"https://chrishavlin.github.io/#author"},"keywords":["code","geodata"],"articleSection":["tutorials"],"inLanguage":"en","author":{"@type":"Person","name":null},"potentialAction":[{"@type":"CommentAction","name":"Comment","target":["https://chrishavlin.github.io/post/to_web_mercator_1/#comments"]}]}]}</script><link type=text/css rel=stylesheet href=/css/print.css media=print><link type=text/css rel=stylesheet href=/css/poole.css><link type=text/css rel=stylesheet href=/css/hyde.css><style type=text/css>.sidebar{background-color:#3b7044}.read-more-link a{border-color:#3b7044}.read-more-link a:hover{background-color:#3b7044}.pagination li a{color:#3b7044;border:1px solid #3b7044}.pagination li.active a{background-color:#3b7044}.pagination li a:hover{background-color:#3b7044;opacity:.75}footer a,.content a,.related-posts li a:hover{color:#3b7044}</style><link type=text/css rel=stylesheet href=/css/blog.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin=anonymous><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><div class=author-image><a href=https://chrishavlin.github.io/><img src=/images/turt.png class="img-circle img-headshot center" alt="Profile Picture"></a></div><h1>Chris Havlin</h1><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chrishavlin.github.io/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li></ul></nav><section class=social-icons><a href=https://github.com/chrishavlin rel=me title=GitHub target=_blank><i class="fab fa-github" aria-hidden=true></i></a><a href=https://twitter.com/s_i_r_h_c rel=me title=@s_i_r_h_c target=_blank><i class="fab fa-twitter" aria-hidden=true></i></a><a href=https://www.instagram.com/chrishavlin/ rel=me title=@chrishavlin target=_blank><i class="fab fa-instagram" aria-hidden=true></i></a><a href=https://www.linkedin.com/in/christopherhavlin/ rel=me title=Linkedin target=_blank><i class="fab fa-linkedin" aria-hidden=true></i></a></section></div></aside><main class="content container"><div class=post><h1 class=title>So you want to plot a global geoTIFF in web mercator...</h1><div class=post-date><time datetime=2022-11-10T17:13:08-0600>Nov 10, 2022</time> <span class=readtime>&#183; 7 min read</span></div><div><p>Need to go from epsg:4326 to web mercator and you&rsquo;re a bit of a GIS n00b like me? Read on!</p><p>This week I found myself in the following situation: I had a geoTIFF of a NASA data product and I needed to get that geoTIFF into a web-ready format. The main trickiness here was that the geoTIFF was a global image in a standard epsg:4326 cooredinate reference systems and most web-app mapping tools work in a web mercator projection (epsg:3857). And while I remembered that web mercator isn&rsquo;t great near the poles, I didn&rsquo;t realize just <strong>how</strong> bad it was&mldr;</p><p>In this post, I&rsquo;ll walk through the problem of re-projection, first showing you what not to do (and why it&rsquo;s bad) before showing you a nice way to re-project a geoTIFF and save off a bitmap image.</p><p>For other mapping-related work, I&rsquo;ve used the <code>rasterio</code> python package and found it generally a great tool, and so that&rsquo;s what I&rsquo;ll be using here.</p><h3 id=packages>Packages</h3><p>This the code here requires the following:</p><ul><li><code>rasterio</code></li><li><code>matplotlib</code></li><li><code>numpy</code></li><li><code>pyproj</code></li><li><code>PIL</code></li></ul><p>all of which are available via pip or conda.</p><h3 id=data>Data</h3><p>For this notebook, we&rsquo;ll use some sample data from <a href=https://www.naturalearthdata.com>NaturalEarthData</a>. Importantly, this is a <strong>global</strong> raster, covering longitude from -180 to 180 degrees and latitudes from -90 to 90 degrees. The exact dataset can be downloaded from:</p><p><a href=https://www.naturalearthdata.com/downloads/10m-raster-data/10m-gray-earth/>https://www.naturalearthdata.com/downloads/10m-raster-data/10m-gray-earth/</a></p><p>The following uses the large, &ldquo;Shaded Relief, Hypsography, Ocean Bottom, and Drainages&rdquo; version. Download and unzip the folder and update the filepath in this notebook if necessary.</p><h2 id=initial-data-inspection>Initial Data Inspection</h2><p>Let&rsquo;s start by loading the .tif file and plotting what we have:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> rasterio <span style=color:#f92672>as</span> rio
<span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#f92672>as</span> plt

fpath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GRAY_HR_SR_OB_DR/GRAY_HR_SR_OB_DR.tif&#34;</span>

src <span style=color:#f92672>=</span> rio<span style=color:#f92672>.</span>open(fpath)
im <span style=color:#f92672>=</span> src<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>1</span>)

</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>plt<span style=color:#f92672>.</span>imshow(im, cmap<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;plasma&#34;</span>)
</code></pre></div><p><img src=/images/to_web_mercator_1_files/to_web_mercator_1_2_1.png alt=png></p><p>We can check the coordinate reference system to see that we are indeed in epsg:4326:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>src<span style=color:#f92672>.</span>crs
</code></pre></div><pre><code>CRS.from_epsg(4326)
</code></pre><p>and we can check the bounds with</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>src<span style=color:#f92672>.</span>bounds
</code></pre></div><pre><code>BoundingBox(left=-180.0, bottom=-90.000000000036, right=180.00000000007202, top=90.00000000000001)
</code></pre><p>and some more metadata:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>src<span style=color:#f92672>.</span>profile
</code></pre></div><pre><code>{'driver': 'GTiff', 'dtype': 'uint8', 'nodata': None, 'width': 21600, 'height': 10800, 'count': 1, 'crs': CRS.from_epsg(4326), 'transform': Affine(0.01666666666667, 0.0, -180.0,
       0.0, -0.01666666666667, 90.00000000000001), 'blockysize': 1, 'tiled': False, 'interleave': 'band'}
</code></pre><p>So we see that there&rsquo;s a single band (since this a greyscale image) and the bounds do indeed grom from +/-180 longitude and +/-90 latitude.</p><h2 id=projecting-to-web-mercator-epsg3857>Projecting to web mercator EPSG:3857</h2><p>Ok, so now maybe we want to use this nice image as a base layer in some mapping web-app like MapBox, Leaflet, or any number of other web-based mapping service. Many of these services do provide some of their own projection/transformation methods, but often it&rsquo;s easier to just pre-compute the projection so that you have an image that&rsquo;s already in the expected web mercator projection.</p><p>Projecting (or re-projecting) with <code>rasterio</code> is very straightforward. <code>rasterio</code>&rsquo;s <a href=https://rasterio.readthedocs.io/en/latest/topics/reproject.html#reprojection>documention on Reproduction</a> even covers this exact case where we what to go from 4326 to 3857! Easy peasy, right?</p><p>So let&rsquo;s just naively follow the <code>rasterio</code> example. First, let&rsquo;s set our destination coordinate reference:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>dst_epsg <span style=color:#f92672>=</span> <span style=color:#ae81ff>3857</span>
dst_crs <span style=color:#f92672>=</span> rio<span style=color:#f92672>.</span>crs<span style=color:#f92672>.</span>CRS<span style=color:#f92672>.</span>from_epsg(dst_epsg)
</code></pre></div><p>and now we calculate the transform needed to go between our source and destination crs. THe following function also computes the resulting width and height of the image:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> rasterio.warp <span style=color:#f92672>import</span> calculate_default_transform
transform, width, height <span style=color:#f92672>=</span> calculate_default_transform(
    src<span style=color:#f92672>.</span>crs, dst_crs, src<span style=color:#f92672>.</span>width, src<span style=color:#f92672>.</span>height, <span style=color:#f92672>*</span>src<span style=color:#f92672>.</span>bounds)
</code></pre></div><p>ok, let&rsquo;s check the size of our new image&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>(src<span style=color:#f92672>.</span>width, src<span style=color:#f92672>.</span>height)
</code></pre></div><pre><code>(21600, 10800)
</code></pre><p>hmm, the width is about twice the height. well, I dunno, maybe that&rsquo;s right. Let&rsquo;s keep going!</p><p>Next, first iniitalize an empty array of our expected height and width, and then we <code>reproject</code> into that array (rather than writing a new file, like in the <code>rasterio</code> example):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> rasterio.warp <span style=color:#f92672>import</span> reproject, Resampling
<span style=color:#f92672>import</span> numpy <span style=color:#f92672>as</span> np

dst_array <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>empty((height, width))

_  <span style=color:#f92672>=</span> reproject(
    source<span style=color:#f92672>=</span>src<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>1</span>),
    destination<span style=color:#f92672>=</span>dst_array,
    src_transform<span style=color:#f92672>=</span>src<span style=color:#f92672>.</span>transform,
    src_crs<span style=color:#f92672>=</span>src<span style=color:#f92672>.</span>crs,
    dst_transform<span style=color:#f92672>=</span>transform,
    dst_crs<span style=color:#f92672>=</span>dst_crs,
    resampling<span style=color:#f92672>=</span>Resampling<span style=color:#f92672>.</span>nearest)

</code></pre></div><p>great! now we&rsquo;re ready to plot!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>plt<span style=color:#f92672>.</span>imshow(dst_array, cmap<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;plasma&#34;</span>)
</code></pre></div><p><img src=/images/to_web_mercator_1_files/to_web_mercator_1_18_1.png alt=png></p><p>well. hmm. that&rsquo;s&mldr; something? At least the continents are there?</p><h2 id=web-mercator-limits>web mercator limits</h2><p>Well, all you GIS non-n00bs are probably laughing by now, because you know. But it took me a while to realize what was happening.</p><p>The issue actually comes straight from the definition of web mercator! You can check <a href=https://web.archive.org/web/20141009142830/http://earth-info.nga.mil/GandG/wgs84/web_mercator/(U)%20NGA_SIG_0011_1.0.0_WEBMERC.pdf>this NGA PDF documentation</a> for a real deep dive, but in slightly simplified form (with no offsets), the x-axis (or the &ldquo;easting&rdquo; direction) is calculated with:</p><pre><code>E = a * lon_radians
</code></pre><p>where <code>a</code> is the semi-major axis of the reference ellipse used (the earth&rsquo;s mean radius!) and <code>lon_radians</code> is the longitude in radians.</p><p>For the y-axis, the &ldquo;northing&rdquo; direction, we have:</p><pre><code>N = a * ln(tan(pi/4 + lat_radians/2))
</code></pre><p>where <code>lat_radians</code> is the latitude in radians.</p><p>And that tangent there is where we&rsquo;re running into trouble with our reprojection, because as latitude approahces +/-90, we&rsquo;ll be hitting that discontinuity, which is what&rsquo;s causing our map to stretch out like crazy. Let&rsquo;s use <code>pyproj</code> to actually show the northing direction as you approach the poles:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> pyproj <span style=color:#f92672>import</span> Transformer

transformer <span style=color:#f92672>=</span> Transformer<span style=color:#f92672>.</span>from_crs(<span style=color:#e6db74>&#34;epsg:4326&#34;</span>, <span style=color:#e6db74>&#34;epsg:3857&#34;</span>)

lon <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>full((<span style=color:#ae81ff>1000</span>,),<span style=color:#f92672>-</span><span style=color:#ae81ff>180</span>)
lat <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>linspace(<span style=color:#ae81ff>80</span>,<span style=color:#ae81ff>89.99999</span>, <span style=color:#ae81ff>1000</span>)
x, y <span style=color:#f92672>=</span> transformer<span style=color:#f92672>.</span>transform(lat, lon)
plt<span style=color:#f92672>.</span>plot(lat, y)
plt<span style=color:#f92672>.</span>xlabel(<span style=color:#e6db74>&#34;latitude&#34;</span>)
plt<span style=color:#f92672>.</span>ylabel(<span style=color:#e6db74>&#34;northing axis&#34;</span>)
</code></pre></div><p><img src=/images/to_web_mercator_1_files/to_web_mercator_1_20_1.png alt=png></p><p>yikes!</p><p>So that&rsquo;s why, when you look up info on web-mercator, it gives the map bounds as +/-85 degrees latitude or so (<a href=https://en.wikipedia.org/wiki/Web_Mercator_projectionhttps://en.wikipedia.org/wiki/Web_Mercator_projection>wikipedia says google uses +/-85.051129 degrees</a>).</p><p>If we just plot from +/-85, we see that the variation is nicely defined:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>lon <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>full((<span style=color:#ae81ff>1000</span>,),<span style=color:#f92672>-</span><span style=color:#ae81ff>180</span>)
lat <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>linspace(<span style=color:#f92672>-</span><span style=color:#ae81ff>85</span>,<span style=color:#ae81ff>85</span>, <span style=color:#ae81ff>1000</span>)
x, y <span style=color:#f92672>=</span> transformer<span style=color:#f92672>.</span>transform(lat, lon)
plt<span style=color:#f92672>.</span>plot(lat, y)
plt<span style=color:#f92672>.</span>xlabel(<span style=color:#e6db74>&#34;latitude&#34;</span>)
plt<span style=color:#f92672>.</span>ylabel(<span style=color:#e6db74>&#34;northing axis&#34;</span>)
</code></pre></div><p><img src=/images/to_web_mercator_1_files/to_web_mercator_1_22_1.png alt=png></p><p>There&rsquo;s still some nonlinearity that causes the poles to stretch but as most web-mapping applications are concerned more with human habitation, the distortion at the poles is not such a big deal.</p><h2 id=re-projecting-the-rigth-way>re-projecting the rigth way</h2><p><strong>OK!</strong> So back to the problem at hand!</p><p>The thing to realize is that <strong><code>rasterio</code> does not enforce the +/-85 degree range</strong> and we need to account for that! Note that I&rsquo;m not saying <code>rasterio</code> should account for it, there&rsquo;s a good argument to requiring users to clip their own data in ways that are appropriate for their use case. But it does require you to remember the limits here!</p><p>The solution is to of course clip our geoTIFF to avoid the problematic poles. We can do this by building a <code>rasterio</code> <code>Window</code> to use in the transformation.</p><p>First, let&rsquo;s initialize a window using a <code>BoundingBox</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>clip_box <span style=color:#f92672>=</span> rio<span style=color:#f92672>.</span>coords<span style=color:#f92672>.</span>BoundingBox(<span style=color:#f92672>-</span><span style=color:#ae81ff>180.</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>85.</span>, <span style=color:#ae81ff>180.</span>, <span style=color:#ae81ff>85.</span>)
clip_window <span style=color:#f92672>=</span> src<span style=color:#f92672>.</span>window(<span style=color:#f92672>*</span>clip_box)
</code></pre></div><p>and let&rsquo;s round that window (in case we&rsquo;ve selected lat/lon ranges that fall between pixels) and then pull out the height and width of our window:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>clip_window <span style=color:#f92672>=</span> clip_window<span style=color:#f92672>.</span>round_lengths()
window_height <span style=color:#f92672>=</span> int(clip_window<span style=color:#f92672>.</span>height)
window_width <span style=color:#f92672>=</span> int(clip_window<span style=color:#f92672>.</span>width)

(window_height, window_width)
</code></pre></div><pre><code>(10200, 21600)
</code></pre><p>the other key is that rather than using the <code>src.transform</code> in our call to <code>reproject</code>, we need to build a <code>window_transform</code> that takes into account the clipping that we want:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>window_tform <span style=color:#f92672>=</span> src<span style=color:#f92672>.</span>window_transform(clip_window)
</code></pre></div><p>and now we&rsquo;re ready to calculate the source to destination transformation (where we are suppling the clipping window properties):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>transform, width, height <span style=color:#f92672>=</span> calculate_default_transform(
    src<span style=color:#f92672>.</span>crs, dst_crs, window_width, window_height, <span style=color:#f92672>*</span>clip_box)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>(width, height)
</code></pre></div><pre><code>(16919, 16863)
</code></pre><p>and we get something much closer to square (as you should for a web-mercator global projection).</p><p>So now let&rsquo;s finish up our transform. Not that we are suppling the window transform as the <code>src_transform</code> here:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>dst_array <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>empty((height, width))

_  <span style=color:#f92672>=</span> reproject(
    source<span style=color:#f92672>=</span>src<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>1</span>),
    destination<span style=color:#f92672>=</span>dst_array,
    src_transform<span style=color:#f92672>=</span>window_tform, <span style=color:#75715e># important! no longer src.transform,</span>
    src_crs<span style=color:#f92672>=</span>src<span style=color:#f92672>.</span>crs,
    dst_transform<span style=color:#f92672>=</span>transform,
    dst_crs<span style=color:#f92672>=</span>dst_crs,
    resampling<span style=color:#f92672>=</span>Resampling<span style=color:#f92672>.</span>nearest)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>plt<span style=color:#f92672>.</span>imshow(dst_array, cmap<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;plasma&#34;</span>)
</code></pre></div><pre><code>&lt;matplotlib.image.AxesImage at 0x7f305e6ba020&gt;
</code></pre><p><img src=/images/to_web_mercator_1_files/to_web_mercator_1_34_1.png alt=png></p><p>that&rsquo;s <strong>much</strong> better, isn&rsquo;t it??</p><h2 id=exporting-as-a-png>Exporting as a PNG</h2><p>So now, we have our data projected into web-mercator and stored in that <code>dst_array</code>, from where you could do any number of things. One likely use case is that you want to save off a bitmap of this to use as a base layer in a web app&mldr; So let&rsquo;s do that!</p><p>Let&rsquo;s start by applying a colormap to our re-projected data array. First we need to scale between 0,1 then apply a matplobli colormap and cast the result as integers between 0 and 255:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> matplotlib <span style=color:#f92672>import</span> cm

scaled_dst <span style=color:#f92672>=</span> (dst_array <span style=color:#f92672>-</span> dst_array<span style=color:#f92672>.</span>min())<span style=color:#f92672>/</span>(dst_array<span style=color:#f92672>.</span>max() <span style=color:#f92672>-</span> dst_array<span style=color:#f92672>.</span>min())
scaled_dst <span style=color:#f92672>=</span> cm<span style=color:#f92672>.</span>plasma(scaled_dst)
scaled_dst <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>uint8(scaled_dst<span style=color:#f92672>*</span><span style=color:#ae81ff>255</span>)
</code></pre></div><p>And now we can initalize our <code>PIL.Image</code>. We&rsquo;ll also resize at fixed aspect ratio (cause I don&rsquo;t need a 100MB+ png in my life), then save (and display again):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image

new_width <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>
img <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>fromarray(scaled_dst)

height_over_width <span style=color:#f92672>=</span> float(img<span style=color:#f92672>.</span>size[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>/</span> img<span style=color:#f92672>.</span>size[<span style=color:#ae81ff>0</span>]
new_height <span style=color:#f92672>=</span> int(height_over_width <span style=color:#f92672>*</span> new_width)

img <span style=color:#f92672>=</span> img<span style=color:#f92672>.</span>resize((new_width, new_height), Image<span style=color:#f92672>.</span>Resampling<span style=color:#f92672>.</span>LANCZOS)
img<span style=color:#f92672>.</span>save(<span style=color:#e6db74>&#39;rescaled.png&#39;</span>)
img
</code></pre></div><p><img src=/images/to_web_mercator_1_files/to_web_mercator_1_38_0.png alt=png></p><p>And a small image like that is easy to encode and send over the web as needed! And it&rsquo;s already in web mercator, ready for use as a global base layer.</p><h2 id=summary>summary</h2><p>So remember folks, clip before projecting!</p><p>Happy mapping!</p></div><div><ul class=tags><li><a href=https://chrishavlin.github.io/tags/code/ class=tag-link>code</a></li><li><a href=https://chrishavlin.github.io/tags/geodata/ class=tag-link>geodata</a></li></ul></div><div class=share-buttons><a class=twitter-share-button href=# title="Share on Twitter" data-url=https://chrishavlin.github.io/post/to_web_mercator_1/ data-text="So you want to plot a global geoTIFF in web mercator..."><i class="fab fa-twitter"></i></a><a class=linkedin-share-button href=# title="Share on LinkedIn" data-url=https://chrishavlin.github.io/post/to_web_mercator_1/ data-text="So you want to plot a global geoTIFF in web mercator..."><i class="fab fa-linkedin-in"></i></a><a class=facebook-share-button href=# title="Share on Facebook" data-url=https://chrishavlin.github.io/post/to_web_mercator_1/ data-text="So you want to plot a global geoTIFF in web mercator..."><i class="fab fa-facebook"></i></a><a class=telegram-share-button href=# title="Share on Telegram" data-url=https://chrishavlin.github.io/post/to_web_mercator_1/ data-text="So you want to plot a global geoTIFF in web mercator..."><i class="fab fa-telegram"></i></a><a class=pinterest-share-button href=# title="Share on Pinterest" data-url=https://chrishavlin.github.io/post/to_web_mercator_1/ data-text="So you want to plot a global geoTIFF in web mercator..."><i class="fab fa-pinterest"></i></a></div></div></main><footer><div><p>&copy; Chris Havlin 2024
&#183; <a href=https://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a>
&#183; Build with <a href=https://gohugo.io/ target=_blank>Hugo</a> & <a href=https://themes.gohugo.io/soho/ target=_blank>Soho</a> theme</p></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin=anonymous></script><script src=/js/jquery.min.js></script><script src=/js/soho.js></script></body></html>