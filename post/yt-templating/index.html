<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.81.0"><title>yt templating &#183; Chris Havlin</title><meta name=description content><meta itemprop=name content="yt templating"><meta itemprop=description content="I recently started working on a CookieCutter template for yt called ytcookiecutter!"><meta itemprop=datePublished content="2021-10-20T16:58:04-05:00"><meta itemprop=dateModified content="2021-10-20T16:58:04-05:00"><meta itemprop=wordCount content="738"><meta itemprop=image content="https://chrishavlin.github.io/images/turt.png"><meta itemprop=keywords content="code,yt,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chrishavlin.github.io/images/turt.png"><meta name=twitter:title content="yt templating"><meta name=twitter:description content="I recently started working on a CookieCutter template for yt called ytcookiecutter!"><meta property="og:title" content="yt templating"><meta property="og:description" content="I recently started working on a CookieCutter template for yt called ytcookiecutter!"><meta property="og:type" content="article"><meta property="og:url" content="https://chrishavlin.github.io/post/yt-templating/"><meta property="og:image" content="https://chrishavlin.github.io/images/turt.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-10-20T16:58:04-05:00"><meta property="article:modified_time" content="2021-10-20T16:58:04-05:00"><meta property="og:site_name" content="Chris Havlin"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://chrishavlin.github.io/#author","name":null,"image":{"@type":"ImageObject","url":"https://chrishavlin.github.io/images/turt.png"},"description":" "},{"@type":"WebSite","@id":"https://chrishavlin.github.io/#website","url":"https://chrishavlin.github.io/","name":"Chris Havlin","description":" ","publisher":{"@id":"https://chrishavlin.github.io/#author"},"inLanguage":"en"},{"@type":"ImageObject","url":"https://chrishavlin.github.io/images/turt.png","caption":"Chris Havlin"},{"@type":"WebPage","@id":"https://chrishavlin.github.io/post/yt-templating/#webpage","url":"https://chrishavlin.github.io/post/yt-templating/","name":"yt templating","isPartOf":{"@id":"https://chrishavlin.github.io/#website"},"about":{"@id":"https://chrishavlin.github.io/#author"},"datePublished":"2021-10-20T16:58:04-05:00","dateModified":"2021-10-20T16:58:04-05:00","description":"I recently started working on a CookieCutter template for yt called ytcookiecutter!","inLanguage":"en","potentialAction":[{"@type":"ReadAction","target":["https://chrishavlin.github.io/post/yt-templating/"]}]},{"@type":"Article","isPartOf":{"@id":"https://chrishavlin.github.io/post/yt-templating/#webpage"},"mainEntityOfPage":{"@id":"https://chrishavlin.github.io/post/yt-templating/#webpage"},"headline":"yt templating","datePublished":"2021-10-20T16:58:04-05:00","dateModified":"2021-10-20T16:58:04-05:00","publisher":{"@id":"https://chrishavlin.github.io/#author"},"keywords":["code","yt"],"articleSection":["demo","news"],"inLanguage":"en","author":{"@type":"Person","name":null},"potentialAction":[{"@type":"CommentAction","name":"Comment","target":["https://chrishavlin.github.io/post/yt-templating/#comments"]}]}]}</script><link type=text/css rel=stylesheet href=/css/print.css media=print><link type=text/css rel=stylesheet href=/css/poole.css><link type=text/css rel=stylesheet href=/css/hyde.css><style type=text/css>.sidebar{background-color:#3b7044}.read-more-link a{border-color:#3b7044}.read-more-link a:hover{background-color:#3b7044}.pagination li a{color:#3b7044;border:1px solid #3b7044}.pagination li.active a{background-color:#3b7044}.pagination li a:hover{background-color:#3b7044;opacity:.75}footer a,.content a,.related-posts li a:hover{color:#3b7044}</style><link type=text/css rel=stylesheet href=/css/blog.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin=anonymous><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><div class=author-image><a href=https://chrishavlin.github.io/><img src=/images/turt.png class="img-circle img-headshot center" alt="Profile Picture"></a></div><h1>Chris Havlin</h1><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chrishavlin.github.io/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li></ul></nav><section class=social-icons><a href=https://github.com/chrishavlin rel=me title=GitHub target=_blank><i class="fab fa-github" aria-hidden=true></i></a><a href=https://twitter.com/s_i_r_h_c rel=me title=@s_i_r_h_c target=_blank><i class="fab fa-twitter" aria-hidden=true></i></a><a href=https://www.instagram.com/chrishavlin/ rel=me title=@chrishavlin target=_blank><i class="fab fa-instagram" aria-hidden=true></i></a><a href=https://www.linkedin.com/in/christopherhavlin/ rel=me title=Linkedin target=_blank><i class="fab fa-linkedin" aria-hidden=true></i></a></section></div></aside><main class="content container"><div class=post><h1 class=title>yt templating</h1><div class=post-date><time datetime=2021-10-20T16:58:04-0500>Oct 20, 2021</time> <span class=readtime>&#183; 4 min read</span></div><div><p>I recently started working on a <a href=https://github.com/cookiecutter/cookiecutter><code>CookieCutter</code></a> template for yt called <a href=https://github.com/data-exp-lab/ytcookiecutter><code>ytcookiecutter</code></a>! The aim is to provide a convenient method for spinning up a new yt-related package, particularly new frontend plugins. The usage follows any <code>CookieCutter</code> template.</p><pre><code>pip install cookiecutter
cookiecutter https://github.com/data-exp-lab/ytcookiecutter
</code></pre><p>will install <code>CookieCutter</code> and bring up the <code>CookieCutter</code> recipe builder. The template is built off audreyfeldroy&rsquo;s excellent <a href=https://github.com/audreyfeldroy/cookiecutter-pypackage/><code>cookiecutter-pypackage</code></a> with some extra yt-specific options. At present, the yt options include options for including some expanded yt-dependencies in a <code>requirements.txt</code> file and the initial code needed for a frontend:</p><pre><code>include_yt_requirements [y]:
Select frontend_type:
1 - None
2 - AMR Skeleton
3 - Stream: Uniform Grid
4 - Stream: AMR Grids
5 - Stream: Particles
6 - Stream: Octree
7 - Stream: Hexahedral Mesh
8 - Stream: Unstructured Mesh
Choose from 1, 2, 3, 4, 5, 6, 7, 8 [1]: 2
</code></pre><p>Once selections are made, a new directory with everything you need to start building your new yt project is available! This includes source code but also github actions and other configurations (like pre-commit).</p><h3 id=how-it-works>how it works</h3><p>One of the neat things about <code>ytcookiecutter</code> is that it actually does some meta-templating to generate the CookieCutter template! If you check out the base <code>ytcookiecutter</code> <a href=https://github.com/data-exp-lab/ytcookiecutter>repository</a>, you&rsquo;ll see some things common to other <code>CookieCutter</code> templates. The directory <code>{{cookiecutter.project_slug}}</code> contains the actual template code. When you run</p><pre><code>cookiecutter https://github.com/data-exp-lab/ytcookiecutter
</code></pre><p>the options you choose will fill in or select certain files in the template code.</p><p>But writing the template code itself can be time consuming. One of the frontend options I added is for a wrapper around an in-memory <code>stream</code> dataset. Now it&rsquo;s true that if you&rsquo;re familiar with yt, you can simply use a function like <code>yt.load_uniform_grid</code> to load in-memory data as a yt dataset. But several times I&rsquo;ve found myself writing wrappers to <code>yt.load_uniform_grid</code> to load from disk and then load into yt. I do this a lot working with gridded seismic data that is small enough to work with in memory and not worth the extra development time of a full yt frontend. So I wanted to add a frontend option for a stream wrapper.</p><p>But if you actually check out the <code>stream</code> template code, you&rsquo;ll see it&rsquo;s fairly long and repetitive ( <a href=https://github.com/data-exp-lab/ytcookiecutter/blob/main/%7B%7Bcookiecutter.project_slug%7D%7D/%7B%7Bcookiecutter.project_slug%7D%7D/frontend_templates/stream/%7B%7Bcookiecutter.project_slug%7D%7D.py>link</a>). Each of the <code>Stream</code> types has different arguments and so each needed their own version in the template. Annoying to write by hand&mldr;</p><p>BUT I don&rsquo;t have to write it by hand!</p><p>While <a href=https://github.com/data-exp-lab/ytcookiecutter><code>ytcookiecutter</code></a> <strong>is</strong> a template, it is <strong>also</strong> a package itself to maintain the template. Among other things, it uses <a href=https://jinja.palletsprojects.com/en/3.0.x/>jinja</a> (which <code>CookieCutter</code> is actually built on) for some meta-templating. The base <code>stream</code> meta-template looks like:</p><pre><code>{%- if cookiecutter.frontend_type|lower == &quot;!{frontend_type_str}!&quot; -%}
from yt.loaders import !{load_func}!

def load(filename: str):

    # write code to load data from filename into memory!
    &lt;% for arg in argnames -%&gt;
    !{arg}! = ????????
    &lt;% endfor %&gt;
    # set or delete optional kwargs
    &lt;% for key, value in kwarg_dict.items() -%&gt;
    !{key}! = !{value}!
    &lt;% endfor %&gt;
    # call the stream data loader
    ds = !{load_func}!(
        &lt;% for arg in argnames -%&gt;
        !{arg}!,
        &lt;% endfor -%&gt;
        &lt;% for key in kwarg_dict.keys() -%&gt;
        !{key}! = !{key}!,
        &lt;% endfor %&gt;
    )

    # return the in-memory ds
    return ds
&lt;% if include_docstring -%&gt;
# description of !{load_func}! for convenience:

&quot;&quot;&quot;
!{docstring}!
&quot;&quot;&quot;
&lt;% endif %&gt;
{%- endif -%}
</code></pre><p>The main thing to notice is that this contains <strong>two</strong> sets of jinja start/end strings to identify the templated lines. The standard sets, <code>{% %}</code>, <code>{{ }}</code> are those used by <code>CookieCutter</code> while <code>&lt;% %></code> and <code>!{ }!</code> are custom start/end strings used by <code>ytcookiecutter</code>. To generate the <code>stream</code> template, I used <code>inspect.getfullarspec</code> to pull out the arguments and default values for each stream loading function and then used the above meta-template to generate the cookiecutter template, resulting in a template file containing all the arguments for the stream loading functions. And when a <code>stream</code> frontend is selected when building the CookieCutter recipe, only that one will remain in the generated project. Neat-o!</p><p>The <code>Skeleton</code> frontend template gets generated a little more simply. Using the <a href=https://github.com/PyGithub/PyGithub>PyGithub</a> package, I simply fetch yt&rsquo;s <code>frontend/_skeleton</code> code and replace the <code>Skeleton</code> occurrences with cookiecutter template parameters so that when a user selects a <code>Skeleton</code> frontend, the new frontend name can easily be swapped in.</p><p>Both of these approaches have the benefit of easily updating templates if yt changes upstream. Simply go and re-run the generation and push the new templates!</p></div><div><ul class=tags><li><a href=https://chrishavlin.github.io/tags/code/ class=tag-link>code</a></li><li><a href=https://chrishavlin.github.io/tags/yt/ class=tag-link>yt</a></li></ul></div><div class=share-buttons><a class=twitter-share-button href=# title="Share on Twitter" data-url=https://chrishavlin.github.io/post/yt-templating/ data-text="yt templating"><i class="fab fa-twitter"></i></a><a class=linkedin-share-button href=# title="Share on LinkedIn" data-url=https://chrishavlin.github.io/post/yt-templating/ data-text="yt templating"><i class="fab fa-linkedin-in"></i></a><a class=facebook-share-button href=# title="Share on Facebook" data-url=https://chrishavlin.github.io/post/yt-templating/ data-text="yt templating"><i class="fab fa-facebook"></i></a><a class=telegram-share-button href=# title="Share on Telegram" data-url=https://chrishavlin.github.io/post/yt-templating/ data-text="yt templating"><i class="fab fa-telegram"></i></a><a class=pinterest-share-button href=# title="Share on Pinterest" data-url=https://chrishavlin.github.io/post/yt-templating/ data-text="yt templating"><i class="fab fa-pinterest"></i></a></div></div></main><footer><div><p>&copy; Chris Havlin 2024
&#183; <a href=https://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a>
&#183; Build with <a href=https://gohugo.io/ target=_blank>Hugo</a> & <a href=https://themes.gohugo.io/soho/ target=_blank>Soho</a> theme</p></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin=anonymous></script><script src=/js/jquery.min.js></script><script src=/js/soho.js></script></body></html>