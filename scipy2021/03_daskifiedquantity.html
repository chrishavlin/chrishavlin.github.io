
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A Daskified yt : using data &#8212; On the Daskening of yt</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Dasken(yt)" href="04_finalthoughts.html" />
    <link rel="prev" title="A Daskified yt : reading data" href="02_daskifiedread.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">On the Daskening of yt</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   On the Daskening of yt
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_motivation.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_unytdask.html">
   Daskified unyt arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_daskifiedread.html">
   A Daskified yt : reading data
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   A Daskified yt : using data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_finalthoughts.html">
   Dasken(yt)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="99_setup.html">
   Repository notes
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/03_daskifiedquantity.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/chrishavlin/scipy2021_ytDaskening"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#daskified-derived-quantity-calculations">
   daskified
   <code class="docutils literal notranslate">
    <span class="pre">
     derived_quantity
    </span>
   </code>
   calculations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#direct-dask-array-approach">
     direct dask-array approach
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dask-delayed-approach">
     dask-delayed approach
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="a-daskified-yt-using-data">
<h1>A Daskified yt : using data<a class="headerlink" href="#a-daskified-yt-using-data" title="Permalink to this headline">¶</a></h1>
<p>Much of the power of yt lies in what happens to data after it is read in. Many of the operations are designed to interface with the chunk iterator described in the previous section so that calculations can be applied to chunks separately and then aggregated without loading an entire data array into memory.</p>
<div class="section" id="daskified-derived-quantity-calculations">
<h2>daskified <code class="docutils literal notranslate"><span class="pre">derived_quantity</span></code> calculations<a class="headerlink" href="#daskified-derived-quantity-calculations" title="Permalink to this headline">¶</a></h2>
<p>Some of the simpler yt operations are defined by the <a class="reference external" href="https://yt-project.org/doc/analyzing/objects.html#derived-quantities"><code class="docutils literal notranslate"><span class="pre">derived_quantities</span></code></a> class, which registers <code class="docutils literal notranslate"><span class="pre">quantities</span></code> to datasets. For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yt</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load_sample</span><span class="p">(</span><span class="s2">&quot;snapshot_033&quot;</span><span class="p">)</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sphere</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">domain_center</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">sp</span><span class="o">.</span><span class="n">quantities</span><span class="o">.</span><span class="n">extrema</span><span class="p">([(</span><span class="s2">&quot;PartType0&quot;</span><span class="p">,</span> <span class="s2">&quot;Density&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;PartType0&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature&quot;</span><span class="p">)])</span>
</pre></div>
</div>
<p>returns the max/min values for each field. Other <code class="docutils literal notranslate"><span class="pre">quantities</span></code> include operations for calculating weighted averages, spatial locations of extrema values, angular momentum and <a class="reference external" href="https://yt-project.org/doc/analyzing/objects.html#derived-quantities">more</a>. All of these operations work within yt’s chunking context with <code class="docutils literal notranslate"><span class="pre">process_chunk</span></code> reduction operations applied to each chunk and then aggregated.</p>
<div class="section" id="direct-dask-array-approach">
<h3>direct dask-array approach<a class="headerlink" href="#direct-dask-array-approach" title="Permalink to this headline">¶</a></h3>
<p>Given that the daskified particle reader described in the previous section can return a delayed <code class="docutils literal notranslate"><span class="pre">unyt_dask</span></code> array, it is straightfowrd to reduce the code complexity of the <code class="docutils literal notranslate"><span class="pre">derived_quantity</span></code> calculations with standard dask operations. Consider finding the current class for finding the extrema of a field:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Extrema</span><span class="p">(</span><span class="n">DerivedQuantity</span><span class="p">):</span>
    <span class="c1"># &lt;&lt;&lt;&lt; docstring deleted &gt;&gt;&gt;&gt;&gt;</span>

    <span class="k">def</span> <span class="nf">count_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">non_zero</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_vals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">non_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iter_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">non_zero</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">process_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">non_zero</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_determine_fields</span><span class="p">(</span><span class="n">field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">non_zero</span><span class="p">:</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fd</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">fd</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">array_like_field</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">HUGE</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span>
                    <span class="n">array_like_field</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="n">HUGE</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span>
                <span class="p">]</span>
        <span class="k">return</span> <span class="n">vals</span>

    <span class="k">def</span> <span class="nf">reduce_intermediate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="c1"># The values get turned into arrays here.</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">arr</span><span class="p">([</span><span class="n">mis</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mas</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
            <span class="k">for</span> <span class="n">mis</span><span class="p">,</span> <span class="n">mas</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">]</span>
</pre></div>
</div>
<p>The superclass <code class="docutils literal notranslate"><span class="pre">DervideQuantity</span></code>’s <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method will iterate over the chunks, calling <code class="docutils literal notranslate"><span class="pre">process_chunk</span></code> for each one to find each chunks min/max value. Those min/max values are then agreggated with the <code class="docutils literal notranslate"><span class="pre">reduce_intermediate</span></code> function. But when our particle IO returns a <code class="docutils literal notranslate"><span class="pre">unyt_dask</span></code> array, we do not need to explicitly loop over chunks and just call <code class="docutils literal notranslate"><span class="pre">.min()</span></code> and <code class="docutils literal notranslate"><span class="pre">.max()</span></code> on our dask arrays. Our modified class assembles a list of delayed actions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Extrema</span><span class="p">(</span><span class="n">DerivedQuantity</span><span class="p">):</span>

    <span class="c1"># &lt;&lt;&lt;&lt; trimmed &gt;&gt;&gt;&gt;</span>
    
    <span class="k">def</span> <span class="nf">_get_delayed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">non_zero</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">non_zero</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                <span class="n">msk</span> <span class="o">=</span> <span class="n">data</span> <span class="o">!=</span> <span class="mf">0.</span>
                <span class="n">dl</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dl</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">non_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">non_zero</span><span class="p">)</span>
</pre></div>
</div>
<p>and those delayed actions are computed in the <code class="docutils literal notranslate"><span class="pre">super().__call()__</span></code>. Other more complex calculations can be simplified as well – the weighted averages for example can be replaced with calls to Dask’s implementation of <code class="docutils literal notranslate"><span class="pre">average</span></code>.</p>
<p>In practice however, the performance of this naive dask-array approach is not quite as good as the yt-native approach. Here we compare execution times for different <code class="docutils literal notranslate"><span class="pre">derived_quantity</span></code> operations between methods and testing conditions (the test type) as follows:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">test_id</span></code> refers to the following configurations:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">test_id</span></code></p></th>
<th class="head"><p>test type</p></th>
<th class="head"><p>notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">dask_multiproc</span></code></p></td>
<td><p>4 workers, 1 thread per worker</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">dask_mpi</span></code></p></td>
<td><p>4 workers</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">dask</span></code></p></td>
<td><p>no explicit client spinup (defualt <code class="docutils literal notranslate"><span class="pre">Client</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">main_serial</span></code></p></td>
<td><p>standard yt</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">main_mpi</span></code></p></td>
<td><p>standard yt, 4 workers</p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">dask_</span></code> tests use the daskified code branch (link), the <code class="docutils literal notranslate"><span class="pre">main_</span></code> tests use the current <code class="docutils literal notranslate"><span class="pre">main</span></code> branch of yt. Operations are tested on both <code class="docutils literal notranslate"><span class="pre">all_data</span></code> and <code class="docutils literal notranslate"><span class="pre">sphere</span></code> selector objects and include: <code class="docutils literal notranslate"><span class="pre">extrema</span></code>, <code class="docutils literal notranslate"><span class="pre">total_quantity</span></code>, <code class="docutils literal notranslate"><span class="pre">weighted_average_quantity</span></code> and <code class="docutils literal notranslate"><span class="pre">center_of_mass</span></code>. The code for the tests is available in the <code class="docutils literal notranslate"><span class="pre">./code</span></code> directory of this poster’s repository (<a class="reference external" href="https://github.com/chrishavlin/scipy2021_ytDaskening">link</a>, files are <code class="docutils literal notranslate"><span class="pre">./code/test_quantities_*.py</span></code>). Grouping only by the test type, the elapsed execution time for each operation are:</p>
<p><img alt="" src="_images/dask_array_quantities.png" /></p>
<p>The above tests group together multiple tests over <code class="docutils literal notranslate"><span class="pre">sphere</span></code> and <code class="docutils literal notranslate"><span class="pre">all_data</span></code> selector objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sp</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sphere</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">domain_center</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">ad</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">all_data</span><span class="p">()</span>
</pre></div>
</div>
<p>Of the test operations that are currently function for both these operations, we can additionall compare execution times between the selector objects:</p>
<p><img alt="" src="_images/dask_array_quantities_sel.png" /></p>
<p>From the above comparisons, it is clear that the dask-array approach is generally not performing as well as the native yt approach. The main reason for this, is that the native yt methods were carefully written to optimize chunk iteration. For example, when calculating the extrema for multiple fields, each chunk is read only once during which the data for each field is aggregated and then later reduced to the final extrema values. In the dask-array approach, the task graph includes a read for each field being aggregated. The <code class="docutils literal notranslate"><span class="pre">weighted_average_quantities</span></code> and <code class="docutils literal notranslate"><span class="pre">center_of_mass</span></code> daskified calculations perform well compared to their native yt approaches for the default dask <code class="docutils literal notranslate"><span class="pre">Client</span></code>. To improve our approach, we may be able to use a delayed workflow.</p>
</div>
<div class="section" id="dask-delayed-approach">
<h3>dask-delayed approach<a class="headerlink" href="#dask-delayed-approach" title="Permalink to this headline">¶</a></h3>
<p>In previous work (<a class="reference external" href="https://hackmd.io/&#64;chavlin/BJDVGiX0P">overview</a>, <a class="reference external" href="https://github.com/data-exp-lab/yt-dask-experiments/blob/master/notebooks/yt_profiles_with_dask.ipynb">detailed notebook</a>), we compared different methods of calculating a yt profile (a binned statistic) and showed that we actually got the best performance when using a dask delayed workflow that directly uses yt’s already optimized algorithm as opposed to a <code class="docutils literal notranslate"><span class="pre">dask</span> <span class="pre">array.map_blocks</span></code> implementation. We’re currently in the process of repeating the above <code class="docutils literal notranslate"><span class="pre">derived_quantities</span></code> test with a similar delayed work flow approach for calculating derived quantities.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="02_daskifiedread.html" title="previous page">A Daskified yt : reading data</a>
    <a class='right-next' id="next-link" href="04_finalthoughts.html" title="next page">Dasken(yt)</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Chris Havlin<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>